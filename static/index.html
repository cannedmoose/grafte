<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <link rel="stylesheet" href="./styles.css">
  <script type="text/javascript" src="elm.js"></script>
</head>

<body>
  <canvas id = "canvas"></canvas>
  <div id = "elm"></div>
</body>

<script type="text/javascript">
let  app = Elm.Main.init(
  { flags:{},
  node : document.querySelector("#elm")}
  );

let mouseCoords = {x : 0, y: 0}
let shape = []
let ctx = undefined;
let canvas = undefined;

app.ports.draw.subscribe(function(data) {
  shape = data.reverse();
  window.requestAnimationFrame(render);
});

app.ports.draw2.subscribe(function(data) {
  mouseCoords = data
  window.requestAnimationFrame(render);
});

function render(delta) {
  if (!canvas || !ctx) {
    canvas = document.querySelector("#canvas")
    ctx = canvas.getContext("2d");
    console.log("newctx")
  }
  if (shape.lenth == 0) {
    return;
  }
  //console.log("render", mouseCoords,  shape);
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.beginPath()
  ctx.strokeStyle = "black";
  // Draw lines
  for (let i = 0; i < shape.length; i++) {
    let segment = shape[i];
    if(segment.type == "move") {
      ctx.moveTo(segment.coords.x, segment.coords.y) 
    } else {
      ctx.lineTo(segment.coords.x, segment.coords.y)
    }
    ctx.stroke();    
  }

  // Draw line to mouse
  ctx.beginPath()
  let lastShape = shape[shape.length-1]
  ctx.moveTo(lastShape.coords.x, lastShape.coords.y)
  ctx.lineTo(mouseCoords.x, mouseCoords.y)
  ctx.strokeStyle = "blue";
  ctx.stroke();
  
  ctx.closePath();

  // Draw controls
  for (let i = 0; i < shape.length; i++) {
    let segment = shape[i];
    ctx.beginPath();
    ctx.rect(segment.coords.x- 5, segment.coords.y - 5, 10, 10);

    if (ctx.isPointInPath(mouseCoords.x, mouseCoords.y)) {
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 3;
      ctx.fillStyle = "white";
    } else {
      ctx.strokeStyle = "black";
      ctx.lineWidth = 1;
      ctx.fillStyle = "white";
    }
    ctx.fill();
    ctx.stroke();
    
    ctx.closePath();
  }

  ctx.restore();
}

</script>

</html>